# –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π: UTM Tracking & –£–ø—Ä–æ—â–µ–Ω–∏–µ UX

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ ‚úÖ

### 1. **Backend (FastAPI)**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `web_sessions` (UTM-–º–µ—Ç–∫–∏ + —Å–≤—è–∑—å —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `WebSession` –≤ `models.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã schemas: `TrackSessionRequestSchema`, `UpdateSessionTelegramSchema`, `SessionResponseSchema`
- ‚úÖ –°–æ–∑–¥–∞–Ω route `POST /api/track-session` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ UTM-–º–µ—Ç–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
- ‚úÖ –°–æ–∑–¥–∞–Ω route `POST /api/update-session-telegram` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å Telegram ID
- ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω route `POST /api/check` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `session_id`

### 2. **Frontend (Landing Page)**
- ‚úÖ **–£–±—Ä–∞–Ω–∞ —Ñ–æ—Ä–º–∞ —Å –∏–Ω–ø—É—Ç–æ–º** –¥–ª—è –≤–≤–æ–¥–∞ URL ‚Äî –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞!
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ CTA-–∫–Ω–æ–ø–∫–∞** "–û—Ç–∫—Ä—ã—Ç—å Telegram-–±–æ—Ç" ‚Äî –ø—Ä–æ—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ
- ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞–Ω `script.js`:
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ `session_id` (UUID)
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ UTM-–º–µ—Ç–æ–∫ –∏–∑ URL
  - POST –Ω–∞ `/api/track-session` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
  - Deep link: `https://t.me/bot?start=session_{UUID}`

### 3. **Telegram Bot**
- ‚úÖ **–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ `/start`**:
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ deep link `session_UUID`
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å `telegram_id` + `username`
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `session_id` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - **–£–±—Ä–∞–Ω –ø—Ä–∏–∑—ã–≤** –∏–¥—Ç–∏ –Ω–∞ –≤–µ–±-—Ñ–æ—Ä–º—É
- ‚úÖ **–û–±–Ω–æ–≤–ª—ë–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ URL**:
  - –ü–µ—Ä–µ–¥–∞—á–∞ `session_id` –≤ API –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
  - **–£–±—Ä–∞–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ** –≤–µ–±-—Ñ–æ—Ä–º—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ **API Client** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `session_id` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö

### 4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- ‚úÖ `UTM_TRACKING_IMPLEMENTATION.md` ‚Äî –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ `DEPLOYMENT_CHECKLIST.md` ‚Äî –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ

---

## –ù–æ–≤—ã–π —Ñ–ª–æ—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è üöÄ

### –°—Ç–∞—Ä—ã–π (—Å–ª–æ–∂–Ω—ã–π):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ ‚Üí –≤–≤–æ–¥–∏—Ç URL
2. –ö–ª–∏–∫ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Telegram —Å deep link `check_ENCODED_URL`
3. –í –±–æ—Ç–µ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å `/start` —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç
4. **–ü—Ä–æ–±–ª–µ–º–∞**: –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞, UTM –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å

### –ù–æ–≤—ã–π (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ ‚Üí –∫–ª–∏–∫ "–û—Ç–∫—Ä—ã—Ç—å Telegram-–±–æ—Ç"
2. UTM —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (`web_sessions`)
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Telegram —Å `session_UUID`
4. –ë–æ—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é —Å Telegram ID
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç URL** ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç—á—ë—Ç
6. –í –ë–î –ø–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞: UTM ‚Üí Telegram ID ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∏

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ‚ú®

1. **–ü—Ä–æ—â–µ UX**: –æ–¥–∏–Ω —à–∞–≥ –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö (–≤–≤–æ–¥ URL ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ ‚Üí /start)
2. **UTM attribution**: –∑–Ω–∞–µ–º, –ø–æ –∫–∞–∫–æ–π —Ä–µ–∫–ª–∞–º–µ –ø—Ä–∏—à—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
3. **–í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏**: —Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–Ω—É–ª–æ ‚Üí –æ—Ç–∫—Ä—ã–ª–∏ –±–æ—Ç–∞ ‚Üí —Å–¥–µ–ª–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É
4. **–ú–µ–Ω—å—à–µ –±–∞–≥–æ–≤**: –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å deep link / –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º URL
5. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**: –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–Ω–æ–≥–æ —Å–∞–π—Ç–æ–≤, –≤—Å–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Å–µ—Å—Å–∏–∏

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º üîß

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ production –ë–î**:
   ```bash
   railway run alembic upgrade head
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å API_ENDPOINT –≤ `frontend/script.js`**:
   ```javascript
   const API_ENDPOINT = 'https://your-backend.railway.app/api/track-session';
   ```

3. **–ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥**:
   ```bash
   git add .
   git commit -m "feat: add UTM tracking, simplify UX (remove URL input)"
   git push origin main
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É** (—Å–º. `DEPLOYMENT_CHECKLIST.md`)

---

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ üìä

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:
- **–ö–∞–∫–æ–π –∫–∞–Ω–∞–ª (UTM) –¥–∞—ë—Ç –±–æ–ª—å—à–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–π?**
  ```sql
  SELECT utm_source, COUNT(DISTINCT cr.id) as checks
  FROM web_sessions ws
  LEFT JOIN check_requests cr ON ws.session_id = cr.session_id
  GROUP BY utm_source;
  ```

- **–°–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É, –Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–ª–∏ –±–æ—Ç–∞?**
  ```sql
  SELECT COUNT(*) FROM web_sessions WHERE telegram_id IS NULL;
  ```

- **–°–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã–ª–∏ –±–æ—Ç–∞, –Ω–æ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É?**
  ```sql
  SELECT COUNT(*) FROM web_sessions ws
  WHERE telegram_id IS NOT NULL
  AND NOT EXISTS (SELECT 1 FROM check_requests cr WHERE cr.session_id = ws.session_id);
  ```

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã üìù

### Backend:
- `backend/migrations/versions/add_web_sessions_table.py` ‚ú® NEW
- `backend/app/models.py` üîß MODIFIED
- `backend/app/schemas.py` üîß MODIFIED
- `backend/app/routes/session.py` ‚ú® NEW
- `backend/app/routes/check.py` üîß MODIFIED
- `backend/app/main.py` üîß MODIFIED

### Frontend:
- `frontend/index.html` üîß MODIFIED (—É–±—Ä–∞–Ω –∏–Ω–ø—É—Ç, –¥–æ–±–∞–≤–ª–µ–Ω–∞ CTA)
- `frontend/script.js` üîß MODIFIED (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ session tracking)

### Telegram Bot:
- `telegram-bot/handlers/start.py` üîß MODIFIED (–æ–±—Ä–∞–±–æ—Ç–∫–∞ session_id)
- `telegram-bot/handlers/url.py` üîß MODIFIED (–ø–µ—Ä–µ–¥–∞—á–∞ session_id)
- `telegram-bot/services/api_client.py` üîß MODIFIED (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ session_id)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `UTM_TRACKING_IMPLEMENTATION.md` ‚ú® NEW
- `DEPLOYMENT_CHECKLIST.md` ‚ú® NEW

---

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚úÖ

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –±–æ—Ç–∞ **–Ω–∞–ø—Ä—è–º—É—é** (–±–µ–∑ –≤–µ–±-—Ñ–æ—Ä–º—ã), —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ `check_requests` –±–µ–∑ `session_id` –æ—Å—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏
- –ù–∏–∫–∞–∫–∏—Ö breaking changes –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é! üöÄ

–°–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `DEPLOYMENT_CHECKLIST.md` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–µ–ª–∏–∑–∞.
